from kivy.lang import Builder
from kivymd.app import MDApp
from kivy.core.window import Window

import socket

Window.size = (1280, 720)
with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.connect(('127.0.0.1', 4234))


    class MainApp(MDApp):
        def build(self):
            self.theme_cls.theme_style = "Dark"
            self.theme_cls.primary_palette = "BlueGray"
            return Builder.load_file('main.kv')

        def logger(self):
            s.sendall(f'login,{self.root.ids.username.text},{self.root.ids.password.text}'.encode())
            response = s.recv(1024).decode()

            if 'ok' in response:
                if self.root.ids.username.text == 'admin':
                    self.root.current = 'admin'
                else:
                    s.sendall('getUserWebsite'.encode())
                    self.root.ids.user_website.text = f"Your website is: {s.recv(1024).decode()}"
                    self.root.ids.hello_user.text = f"Hello {self.root.ids.username.text}"
                    self.root.current = 'user'

                self.root.ids.response_label.text = ''
                self.root.ids.password.text = ''
                self.root.ids.username.text = ''
            else:
                self.root.ids.response_label.text = response

        def logout(self):
            s.sendall('logout'.encode())
            response = s.recv(1024).decode()
            if response == 'ok':
                self.root.current = 'login'
            self.root.ids.username_register.text = ''
            self.root.ids.password_register.text = ''
            self.root.ids.website_register.text = ''
            self.root.ids.response_label_admin.text = ''
            self.root.ids.test_results.text = "Website tests result will be printed here"

        def register(self):
            s.sendall(f"register,"
                      f"{self.root.ids.username_register.text},"
                      f"{self.root.ids.password_register.text},"
                      f"{self.root.ids.website_register.text} ".encode())
            response = s.recv(1024).decode()

            if response == 'ok':
                self.root.ids.response_label_admin.text = 'User successfully created'
                self.root.ids.username_register.text = ''
                self.root.ids.password_register.text = ''
                self.root.ids.website_register.text = ''

            else:
                self.root.ids.response_label_admin.text = response

        def test_website(self):
            s.sendall("testMyWebsite".encode())
            self.root.ids.test_results.text = s.recv(1024).decode()


    if __name__ == '__main__':
        MainApp().run()
