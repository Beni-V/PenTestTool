from SqliteDatabase import SqliteDatabase
import SqlInjectionScanner


class RequestHandler:
    def __init__(self):
        self.sqlite_database = SqliteDatabase()
        self.logged_users = []
        self.sql_injection_scanner = SqlInjectionScanner.SqlInjectionScanner()

    def login_user(self, user_request):
        username, password = user_request.split(',')[1], user_request.split(',')[2]

        if username in self.logged_users:
            return "Error,User is already logged in"

        if self.sqlite_database.is_user_exist(username) and self.sqlite_database.is_password_match(username, password):
            self.logged_users.append(username)
            return "ok"

        else:
            return "Error,Username or password incorrect"

    def register_user(self, user_request, username):
        if self.sqlite_database.check_if_user_is_admin(username):
            if self.sqlite_database.is_user_exist(user_request.split(',')[1]):
                return "Error,This user is already exist"
            else:
                self.sqlite_database.add_user(user_request.split(',')[1], user_request.split(',')[2],
                                              user_request.split(',')[3])
                return "ok"
        else:
            return "Error,Only admin can register new users"

    def logout(self, username):
        self.logged_users.remove(username)
        return "ok"

    def scan_for_sql_injection(self, username):
        if self.sql_injection_scanner.scan_sql_injection(self.sqlite_database.get_user_website(username)):
            return "Sql injection was detected on the website"
        else:
            return "No vulnerabilities detected on the website."
